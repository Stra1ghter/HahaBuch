@page "/analysis"
@rendermode @(new InteractiveAutoRenderMode(prerender: false))
@using HahaBuch.Client.SharedComponents
@using Microsoft.AspNetCore.Authorization
@using HahaBuch.Charts;
@using Microsoft.Extensions.Localization
@using HahaBuch.SharedContracts
@inject IStringLocalizer<SharedResources> Loc
@inject IAnalysisService AnalysisService

@attribute [Authorize]

<div class="container mt-4">
    <h3>@Loc["Analysis"]</h3>

    @if (_loading)
    {
        <p>Loading analysis...</p>
    }
    else if (_totals.Count == 0)
    {
        <p>No data for @_year.</p>
    }
    else
    {
        <BinaryRadioButton @bind-Value="ExpenseSelected"
                           TrueLabel="@Loc["Expense"]"
                           FalseLabel="@Loc["Income"]"
                           ButtonVariant="outline-secondary"
                            />

        <div class="row">
            <div class="col-md-12">
                <PieChart Slices="@(ExpenseSelected ? _pieSlicesExpenses : _pieSlicesIncome)" OnItemMouseOver="SliceMouseOver" OnItemMouseOut="SliceMouseOut" />
            </div>

                <div class="col-md-12">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>@Loc["Category"]</th>
                                <th>@(ExpenseSelected ? Loc["Expense"] : Loc["Income"])</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if(ExpenseSelected)
                        {
                            @foreach (var t in _totals.Where(t => t.ExpenseTotal > 0).OrderByDescending(x => x.ExpenseTotal))
                            {
                                <tr>
                                    <td>@t.Category</td>
                                    <td>@t.ExpenseTotal</td>
                                </tr>
                            }
                        }
                        else
                        {
                            @foreach (var t in _totals.Where(t => t.IncomeTotal > 0).OrderByDescending(x => x.IncomeTotal))
                            {
                                <tr>
                                    <td>@t.Category</td>
                                    <td>@t.IncomeTotal</td>
                                </tr>
                            }
                        }
                    </tbody>
                    </table>
                </div>
        </div>
    }

    @if (_selected != null)
    {
        <p>@_selected.Label: @_selected.Value (@((_selected.Fraction * 100).ToString("0.##"))%)</p>
    }
</div>

@code {
    private List<CategoryYearTotalDto> _totals = new();
    private List<PieSliceData> _pieSlicesExpenses = new();
    private List<PieSliceData> _pieSlicesIncome = new();
    private bool _loading = true;
    private int _year = DateTime.Now.Year;
    private PieSliceData? _selected = null;
    private bool ExpenseSelected = true;

    protected override async Task OnInitializedAsync()
    {
        if (!RendererInfo.IsInteractive)
            return; // skip during prerender
        _totals = await AnalysisService.GetCategoryYearTotals(_year);
        BuildExpensePieSlices();
        BuildIncomePieSlices();
        _loading = false;
    }

    private void BuildExpensePieSlices()
    {
        _pieSlicesExpenses.Clear();
        decimal total = _totals.Where(t => t.ExpenseTotal > 0).Sum(t => t.ExpenseTotal);
        if (total <= 0) return;
        foreach (var t in _totals.Where(t => t.ExpenseTotal > 0))
        {
            _pieSlicesExpenses.Add(new PieSliceData
            {
                Label = t.Category,
                Color = t.CategoryColor,
                Value = t.ExpenseTotal,
                Fraction = (double)(t.ExpenseTotal / total)
            });
        }
    }

    private void BuildIncomePieSlices()
    {
        _pieSlicesIncome.Clear();
        decimal total = _totals.Where(t => t.IncomeTotal > 0).Sum(t => t.IncomeTotal);
        if (total <= 0) return;
        foreach (var t in _totals.Where(t => t.IncomeTotal > 0))
        {
            _pieSlicesIncome.Add(new PieSliceData
            {
                Label = t.Category,
                Color = t.CategoryColor,
                Value = t.IncomeTotal,
                Fraction = (double)(t.IncomeTotal / total)
            });
        }
    }

    private void SliceMouseOver(object? sender, PieSliceData slice)
    {
        _selected = slice;
        StateHasChanged();
    }

    private void SliceMouseOut(object? sender, PieSliceData slice)
    {
        _selected = null;
        StateHasChanged();
    }

}
