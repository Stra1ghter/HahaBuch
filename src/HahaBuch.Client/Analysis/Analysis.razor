@page "/analysis"
@rendermode @(new InteractiveAutoRenderMode(prerender: false))
@using HahaBuch.Client.SharedComponents
@using Microsoft.AspNetCore.Authorization
@using HahaBuch.Charts;
@using Microsoft.Extensions.Localization
@using HahaBuch.SharedContracts
@using System.Globalization
@inject IStringLocalizer<SharedResources> Loc
@inject IAnalysisService AnalysisService

@attribute [Authorize]

<div class="container mt-4">
    <h3>@Loc["Analysis"]</h3>

    @if (_loading)
    {
        <LoadingIndicator />
    }
    else
    {
        <div class="row mt-3 mb-3 text-center">
            <RadioButtonGroup TOption="int"
                               Options="@([SelectedYear - 1, SelectedYear, SelectedYear + 1])"
                               Value="SelectedYear"
                               ValueChanged="SelectedYearChanged"
                               LabelSelector="@((int year) => year.ToString())"
                               ButtonVariant="outline-secondary" />
        </div>

        <div class="row mt-3 mb-3 text-center">
            <RadioButtonGroup TOption="bool"
                               @bind-Value="ExpenseSelected"
                               Options="@([true, false])"
                               LabelSelector="@((bool option) => option ? Loc["Expense"] : Loc["Income"])"
                               ButtonVariant="outline-secondary" />
        </div>

        <div class="row justify-content-evenly">
            
            @if (_totals.Count == 0)
            {
                <p class="text-center">@string.Format(@Loc["NoDataForYear"], SelectedYear)</p>
            }
            else
            {
                <div class="col-md-6 col-s-12">
                    <PieChart Slices="@(ExpenseSelected? _pieSlicesExpenses : _pieSlicesIncome)" 
                              OnItemMouseOver="SliceMouseOver" 
                              OnItemMouseOut="SliceMouseOut"
                              HighlightedSlice="_highlightedSlice" />
                </div>

                <div class="col-md-6 col-s-12">
                    <table class="table table-sm analysis-totals">
                        <thead>
                            <tr>
                                <th>@Loc["Category"]</th>
                                <th>@(ExpenseSelected? FormatHeaderWithLocalizedCurrencySymbol(Loc["Expense"]) : FormatHeaderWithLocalizedCurrencySymbol(Loc["Income"]))</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if(ExpenseSelected)
                        {
                            @foreach (var t in _totals.Where(t => t.ExpenseTotal > 0).OrderByDescending(x => x.ExpenseTotal))
                            {
                                var slice = _pieSlicesExpenses.FirstOrDefault(s => s.Label == t.Category);
                                <tr class="@(slice == _highlightedSlice ? "table-active" : null)"
                                    @onmouseover="() => TableRowMouseOver(slice)"
                                    @onmouseout="TableRowMouseOut">
                                    <td>@t.Category</td>
                                    <td>@t.ExpenseTotal</td>
                                    <td>@FormatPercentage(t.ExpenseTotal, _expenseSum)</td>
                                </tr>
                            }
                            <tr>
                                <td>@Loc["Sum"]</td>
                                <td>@_totals.Sum(t => t.ExpenseTotal)</td>
                                <td>100%</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var t in _totals.Where(t => t.IncomeTotal > 0).OrderByDescending(x => x.IncomeTotal))
                            {
                                var slice = _pieSlicesIncome.FirstOrDefault(s => s.Label == t.Category);
                                <tr class="@(slice == _highlightedSlice ? "table-active" : null)"
                                    @onmouseover="() => TableRowMouseOver(slice)"
                                    @onmouseout="TableRowMouseOut">
                                    <td>@t.Category</td>
                                    <td>@t.IncomeTotal</td>
                                    <td>@FormatPercentage(t.IncomeTotal, _incomeSum)</td>
                                </tr>
                            }
                            <tr>
                                <td>@Loc["Sum"]</td>
                                <td>@_totals.Sum(t => t.IncomeTotal)</td>
                                <td>100%</td>
                            </tr>
                        }
                    </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<CategoryYearTotalDto> _totals = new();
    private List<PieSliceData> _pieSlicesExpenses = new();
    private List<PieSliceData> _pieSlicesIncome = new();
    private bool _loading = true;
    private PieSliceData? _selected = null;
    private bool ExpenseSelected = true;
    private PieSliceData? _highlightedSlice = null;
    private decimal _expenseSum = 0M;
    private decimal _incomeSum = 0M;
    private int SelectedYear = DateTime.Now.Year;

    protected override async Task OnInitializedAsync()
    {
        if (!RendererInfo.IsInteractive)
            return; // skip during prerender
        _totals = await AnalysisService.GetCategoryYearTotals(SelectedYear);
        BuildExpensePieSlices();
        BuildIncomePieSlices();
        _loading = false;
    }

    private async Task SelectedYearChanged(int newYear)
    {
        _loading = true;
        SelectedYear = newYear;
        _totals = await AnalysisService.GetCategoryYearTotals(SelectedYear);
        BuildExpensePieSlices();
        BuildIncomePieSlices();
        _loading = false;
    }

    private void BuildExpensePieSlices()
    {
        _pieSlicesExpenses.Clear();
        decimal total = _totals.Where(t => t.ExpenseTotal > 0).Sum(t => t.ExpenseTotal);
        _expenseSum = total;
        if (total <= 0) return;
        foreach (var t in _totals.Where(t => t.ExpenseTotal > 0))
        {
            _pieSlicesExpenses.Add(new PieSliceData
            {
                Label = t.Category,
                Color = t.CategoryColor,
                Value = t.ExpenseTotal,
                Fraction = (double)(t.ExpenseTotal / total)
            });
        }
    }

    private void BuildIncomePieSlices()
    {
        _pieSlicesIncome.Clear();
        decimal total = _totals.Where(t => t.IncomeTotal > 0).Sum(t => t.IncomeTotal);
        _incomeSum = total;
        if (total <= 0) return;
        foreach (var t in _totals.Where(t => t.IncomeTotal > 0))
        {
            _pieSlicesIncome.Add(new PieSliceData
            {
                Label = t.Category,
                Color = t.CategoryColor,
                Value = t.IncomeTotal,
                Fraction = (double)(t.IncomeTotal / total)
            });
        }
    }

    private void SliceMouseOver(object? sender, PieSliceData slice)
    {
        _selected = slice;
        _highlightedSlice = slice;
        StateHasChanged();
    }

    private void SliceMouseOut(object? sender, PieSliceData slice)
    {
        _selected = null;
        _highlightedSlice = null;
        StateHasChanged();
    }

    private void TableRowMouseOver(PieSliceData? slice)
    {
        if (slice == null) return;
        _highlightedSlice = slice;
    }

    private void TableRowMouseOut()
    {
        _highlightedSlice = null;
    }

    private string FormatHeaderWithLocalizedCurrencySymbol(string headerText)
        => CultureInfo.CurrentUICulture.NumberFormat.CurrencySymbol != "¤" && !string.IsNullOrEmpty(CultureInfo.CurrentUICulture.NumberFormat.CurrencySymbol)
            ? $"{headerText} ({CultureInfo.CurrentUICulture.NumberFormat.CurrencySymbol})"
            : headerText;

    private string FormatPercentage(decimal value, decimal total)
        => total > 0 ? ((value / total) * 100M).ToString("0.##", CultureInfo.CurrentUICulture) + "%" : "-";
}
